name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        cxx: [g++, clang++]
    steps:
    - uses: actions/checkout@v4
    - name: apt update
      run: sudo apt-get -o Acquire::Retries=3 update
    - name: install opengl
      run: sudo apt-get -o Acquire::Retries=3 install mesa-common-dev libgl1-mesa-dev libgl1 libglx-mesa0 libxext-dev
    - name: install gtk
      run: sudo apt-get -o Acquire::Retries=3 install libgtk-3-dev
    - name: cmake
      run: CXX=${{ matrix.cxx }} cmake -S . -B _build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=TreeSheets-relocatable -DTREESHEETS_RELOCATABLE_INSTALLATION=ON -DGIT_WXWIDGETS_SUBMODULES=ON
    - name: build TreeSheets
      run: cmake --build _build -j4
    - name: install files
      run: cmake --install _build
    - name: zip
      run: zip -r linux_treesheets_${{ matrix.cxx }}.zip TreeSheets-relocatable
    - name: upload build artifacts
      if: github.ref == 'refs/heads/master'
      uses: actions/upload-artifact@v4
      with:
        name: Linux TreeSheets ${{ matrix.cxx }}
        path: TreeSheets-relocatable
    - name: Create release
      if: github.ref == 'refs/heads/master'
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.run_id }}
        allowUpdates: true
        omitBody: true
        commit: master
        artifacts: "linux_treesheets_${{ matrix.cxx }}.zip"

  build-windows:
    name: Build Windows
    runs-on: windows-2022
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.1
    - name: cmake
      run: cmake -S . -B _build -DCMAKE_BUILD_TYPE=Release  -DGIT_WXWIDGETS_SUBMODULES=ON
    - name: build and package
      run: cmake --build _build --config Release --target package -j
    - name: Create release
      if: github.ref == 'refs/heads/master'
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.run_id }}
        allowUpdates: true
        omitBody: true
        commit: master
        artifacts: "_build/TreeSheets-*.exe"

  build-mac:
    name: Build Mac
    runs-on: macos-latest
    env:
      minmac: 10.15
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    - name: Prepare Plist
      run: |
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $(date +'%Y%m%d%H%M%S')" osx/Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $(date +'%Y.%m.%d')" osx/Info.plist
        /usr/libexec/PlistBuddy -c "Set :LSMinimumSystemVersion $minmac" osx/Info.plist
    - name: cmake
      run: cmake -S . -B _build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" -DCMAKE_OSX_DEPLOYMENT_TARGET="$minmac" -DGIT_WXWIDGETS_SUBMODULES=ON
    - name: Build and package TreeSheets
      run: cmake --build _build --target package -j4
    - name: Create release
      if: github.ref == 'refs/heads/master'
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.run_id }}
        allowUpdates: true
        omitBody: true
        commit: master
        artifacts: "_build/TreeSheets-*.dmg"
