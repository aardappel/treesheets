name: CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Cancel redundant runs on same ref to save resources
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  # Base release tag pattern; short SHA computed later
  RELEASE_PREFIX: build

jobs:
  build-linux-x64:
    name: Build Linux x64
    runs-on: ubuntu-latest
    timeout-minutes: 300
    permissions:
      contents: write
    steps:
      - name: Checkout (shallow + submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Install build dependencies (minimal, with ccache & Ninja)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            cmake g++ git mesa-common-dev libgl1-mesa-dev libgl1 libglx-mesa0 libxext-dev \
            libgtk-3-dev dpkg-dev file ccache ninja-build
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Configure TreeSheets (Ninja + ccache)
        run: |
          set -euo pipefail
          cmake -S . -B _build \
            -G Ninja \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCPACK_PACKAGING_INSTALL_PREFIX=/usr \
            -DCMAKE_BUILD_TYPE=Release \
            -DGIT_WXWIDGETS_SUBMODULES=ON \
            -DwxUSE_SYS_LIBS=OFF \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build TreeSheets
        run: |
          set -euo pipefail
          cmake --build _build --target all -j"$(nproc)"

      - name: Run tests
        run: |
          set -euo pipefail
          ctest --test-dir _build --output-on-failure

      - name: Package TreeSheets
        run: |
          set -euo pipefail
          cmake --build _build --target package -j"$(nproc)"

      - name: Sanitize Debian artifact filenames
        run: |
          set -euo pipefail
          shopt -s nullglob
          for file in _build/treesheets_*.deb; do
            base="$(basename "$file")"
            sanitized="$(printf '%s' "$base" | sed -E 's/^(treesheets_)[0-9]+:/\1/; s/:/-/g')"
            if [[ "$sanitized" != "$base" ]]; then
              mv -v "$file" "_build/$sanitized"
            fi
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-builds
          path: _build/treesheets_*.deb
          retention-days: 90

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    timeout-minutes: 300
    permissions:
      contents: write
    steps:
      - name: Checkout (shallow + submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build, test, and package in ARM64 Debian container (Ninja + ccache)
        run: |
          set -euo pipefail
          HOST_UID=$(id -u)
          HOST_GID=$(id -g)
          docker run --rm --pull=always --platform linux/arm64 \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            arm64v8/debian:bookworm \
            bash -c "set -euo pipefail; \
              apt-get update; \
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                ca-certificates \
                cmake g++ git mesa-common-dev libgl1-mesa-dev libgl1 libglx-mesa0 libxext-dev \
                libgtk-3-dev dpkg-dev file ccache ninja-build; \
              update-ca-certificates || true; \
              cmake -S . -B _build \
                -G Ninja \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCPACK_PACKAGING_INSTALL_PREFIX=/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DGIT_WXWIDGETS_SUBMODULES=ON \
                -DwxUSE_SYS_LIBS=OFF \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache; \
              cmake --build _build --target all -j\$(nproc); \
              ctest --test-dir _build --output-on-failure; \
              cmake --build _build --target package -j\$(nproc); \
              shopt -s nullglob; \
              for file in _build/treesheets_*.deb; do \
                base=\$(basename \"\$file\"); \
                sanitized=\$(printf '%s' \"\$base\" | sed -E 's/^(treesheets_)[0-9]+:/\\1/; s/:/-/g'); \
                if [ \"\$sanitized\" != \"\$base\" ]; then mv -v \"\$file\" \"_build/\$sanitized\"; fi; \
              done; \
              chown -R ${HOST_UID}:${HOST_GID} _build; \
              apt-get clean; rm -rf /var/lib/apt/lists/*"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64-builds
          path: _build/treesheets_*.deb
          retention-days: 90

  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    timeout-minutes: 300
    permissions:
      contents: write
    steps:
      - name: Checkout (shallow + submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure TreeSheets
        run: |
          cmake -S . -B _build -DCMAKE_BUILD_TYPE=Release -DGIT_WXWIDGETS_SUBMODULES=ON

      - name: Build TreeSheets
        run: |
          cmake --build _build --config Release --target ALL_BUILD -- /m

      - name: Run tests
        run: |
          ctest --test-dir _build --output-on-failure -C Release

      - name: Package TreeSheets
        run: |
          cmake --build _build --config Release --target package -- /m

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            _build/TreeSheets-*.exe
            _build/TreeSheets-*.zip
          retention-days: 90

  publish-release:
    name: Publish release
    needs:
      - build-linux-x64
      - build-linux-arm64
      - build-windows
    runs-on: ubuntu-latest
    timeout-minutes: 300
    permissions:
      contents: write
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Derive short SHA
        id: sha
        run: echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Download Linux x64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-x64-builds
          path: release/linux-x64

      - name: Download Linux ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-arm64-builds
          path: release/linux-arm64

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-builds
          path: release/windows

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.RELEASE_PREFIX }}-${{ github.run_id }}-${{ steps.sha.outputs.short_sha }}
          name: TreeSheets build ${{ github.run_id }} (${{
            steps.sha.outputs.short_sha }})
          body: "Automated build for commit ${{ github.sha }}"
          allowUpdates: true
          commit: ${{ github.sha }}
          artifacts: |
            release/linux-x64/treesheets_*.deb
            release/linux-arm64/treesheets_*.deb
            release/windows/TreeSheets-*.exe
            release/windows/TreeSheets-*.zip